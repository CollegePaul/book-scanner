<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Book Scanner</title>
    
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <style>
        /* BASIC STYLING */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        
        /* SCANNER CAMERA BOX (Hidden by default) */
        #scanner-container {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 10;
        }
        #scanner-container video {
            width: 100%; height: 100%; object-fit: cover;
        }
        #close-btn {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            background: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;
        }

        /* BUTTONS */
        .btn {
            display: block; width: 100%; padding: 15px; background-color: #007bff; color: white;
            text-align: center; border: none; border-radius: 8px; font-size: 1.2rem; cursor: pointer; margin-bottom: 20px;
        }
        .btn:active { background-color: #0056b3; }

        /* BOOK LIST */
        #book-list { list-style: none; padding: 0; }
        .book-card {
            background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px;
        }
        .book-card img { width: 50px; height: 75px; object-fit: cover; background: #ddd; }
        .book-info h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .book-info p { margin: 0; color: #666; font-size: 0.9rem; }
        .delete-btn {
            margin-left: auto; background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>ðŸ“š My Library</h1>
    
    <button class="btn" onclick="startScan()">ðŸ“· Scan New Book</button>
    
    <div id="status-msg" style="text-align: center; margin-bottom: 10px; color: #666;"></div>

    <ul id="book-list">
        </ul>

    <div id="scanner-container">
        <button id="close-btn" onclick="stopScan()">Close Camera</button>
        <div id="interactive" class="viewport"></div>
    </div>

   <script>
        // --- 1. SETUP & STORAGE ---
        let books = JSON.parse(localStorage.getItem('myLibrary')) || [];
        renderList();

        // --- 2. SCANNER LOGIC (Quagga) ---
        function startScan() {
            document.getElementById('scanner-container').style.display = 'block';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment",
                        // Force higher resolution for better barcode reading
                        width: { min: 640 },
                        height: { min: 480 },
                        aspectRatio: { min: 1, max: 2 }
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                decoder: {
                    // "ean_reader" is for standard ISBN-13
                    // We add "upc_reader" for older mass-market paperbacks
                    readers: ["ean_reader"] 
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Error starting camera. Ensure you are on HTTPS and allow camera access.");
                    stopScan();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const rawCode = result.codeResult.code;
                
                // --- DEBUG: Uncomment this line if you suspect the scanner is misreading numbers ---
                // console.log("Detected raw code:", rawCode);

                if(sessionStorage.getItem('lastScanned') !== rawCode) {
                    sessionStorage.setItem('lastScanned', rawCode);
                    
                    stopScan(); 
                    
                    const audio = new Audio('https://www.soundjay.com/button/beep-07.mp3');
                    audio.play();
                    
                    fetchBookDetails(rawCode);
                }
            });
        }

        function stopScan() {
            Quagga.stop();
            document.getElementById('scanner-container').style.display = 'none';
            sessionStorage.removeItem('lastScanned');
        }

        // --- 3. API LOGIC (Fixed for "Book Not Found") ---
        async function fetchBookDetails(isbn) {
            // Clean the ISBN (remove dashes/spaces if any exist)
            const cleanISBN = isbn.trim().replace(/-/g, "");
            
            document.getElementById('status-msg').innerText = `Scanned: ${cleanISBN}. Searching...`;

            try {
                // We construct the dynamic URL
                const url = `https://openlibrary.org/api/books?bibkeys=ISBN:${cleanISBN}&jscmd=data&format=json`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // --- THE FIX: Get the first object value, regardless of the key name ---
                // OpenLibrary returns { "ISBN:978...": { title: ... } }
                // We use Object.values(data)[0] to grab the inner object directly.
                const bookData = Object.values(data)[0];

                if (bookData) {
                    const newBook = {
                        title: bookData.title,
                        // Handle missing authors gracefully
                        author: bookData.authors ? bookData.authors.map(a => a.name).join(", ") : "Unknown Author",
                        cover: bookData.cover ? bookData.cover.medium : "https://via.placeholder.com/50x75?text=No+Cover",
                        isbn: cleanISBN
                    };

                    books.unshift(newBook); 
                    saveAndRender();
                    document.getElementById('status-msg').innerText = `Success! Added: ${newBook.title}`;
                } else {
                    // Detailed Error Message
                    alert(`Book not found for ISBN: ${cleanISBN}\n\nMake sure you scanned the ISBN barcode (usually starts with 978) and not a generic retail barcode.`);
                    document.getElementById('status-msg').innerText = "Try scanning again.";
                }
            } catch (error) {
                console.error(error);
                alert("Network error or API issue. Check console for details.");
            }
        }

        // --- 4. UI HELPER FUNCTIONS ---
        function saveAndRender() {
            localStorage.setItem('myLibrary', JSON.stringify(books));
            renderList();
        }

        function renderList() {
            const list = document.getElementById('book-list');
            list.innerHTML = "";
            
            books.forEach((book, index) => {
                const li = document.createElement('li');
                li.className = 'book-card';
                li.innerHTML = `
                    <img src="${book.cover}" alt="Cover">
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p>${book.author}</p>
                        <p style="font-size:0.7rem; color:#aaa;">${book.isbn}</p>
                    </div>
                    <button class="delete-btn" onclick="removeBook(${index})">X</button>
                `;
                list.appendChild(li);
            });
        }

        function removeBook(index) {
            if(confirm("Remove this book?")) {
                books.splice(index, 1);
                saveAndRender();
            }
        }
    </script>
</body>
</html>