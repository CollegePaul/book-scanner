<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Book Scanner</title>
    
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <style>
        /* BASIC STYLING */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        
        /* SCANNER CAMERA BOX (Hidden by default) */
        #scanner-container {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 10;
        }
        #scanner-container video {
            width: 100%; height: 100%; object-fit: cover;
        }
        #close-btn {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            background: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer;
        }

        /* BUTTONS */
        .btn {
            display: block; width: 100%; padding: 15px; background-color: #007bff; color: white;
            text-align: center; border: none; border-radius: 8px; font-size: 1.2rem; cursor: pointer; margin-bottom: 20px;
        }
        .btn:active { background-color: #0056b3; }

        /* BOOK LIST */
        #book-list { list-style: none; padding: 0; }
        .book-card {
            background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px;
        }
        .book-card img { width: 50px; height: 75px; object-fit: cover; background: #ddd; }
        .book-info h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .book-info p { margin: 0; color: #666; font-size: 0.9rem; }
        .delete-btn {
            margin-left: auto; background: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>ðŸ“š My Library</h1>
    
    <button class="btn" onclick="startScan()">ðŸ“· Scan New Book</button>
    
    <div id="status-msg" style="text-align: center; margin-bottom: 10px; color: #666;"></div>

    <ul id="book-list">
        </ul>

    <div id="scanner-container">
        <button id="close-btn" onclick="stopScan()">Close Camera</button>
        <div id="interactive" class="viewport"></div>
    </div>

   <script>
        // --- 1. SETUP & STORAGE ---
        let books = JSON.parse(localStorage.getItem('myLibrary')) || [];
        renderList();

        // --- VARIABLES FOR CONFIDENCE CHECK ---
        let lastDetectedCode = null;
        let detectionCount = 0;
        const CONFIDENCE_THRESHOLD = 6; // Must see same code 6 times to accept

        // --- 2. SCANNER LOGIC ---
        function startScan() {
            // Reset variables
            lastDetectedCode = null;
            detectionCount = 0;

            document.getElementById('scanner-container').style.display = 'block';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640 },
                        height: { min: 480 },
                        aspectRatio: { min: 1, max: 2 },
                        focusMode: "continuous" 
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 10, // Scan 10 times per second
                decoder: {
                    readers: ["ean_reader"]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Error starting camera.");
                    stopScan();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const rawCode = result.codeResult.code;

                // 1. Basic filter: Must look like an ISBN (start with 978 or 979)
                if (!rawCode.startsWith('978') && !rawCode.startsWith('979')) return;

                // 2. CONSENSUS LOGIC
                // If this code matches the last one we saw...
                if (rawCode === lastDetectedCode) {
                    detectionCount++;
                    
                    // Optional: Visual feedback so you know it's locking on
                    if (detectionCount % 2 === 0) {
                         console.log(`Verifying... ${detectionCount}/${CONFIDENCE_THRESHOLD}`);
                    }

                    // 3. THRESHOLD REACHED
                    // Only process if we have seen it enough times AND we haven't already saved it this session
                    if (detectionCount >= CONFIDENCE_THRESHOLD) {
                        if(sessionStorage.getItem('lastScanned') !== rawCode) {
                            sessionStorage.setItem('lastScanned', rawCode);
                            stopScan();
                            
                            const audio = new Audio('https://www.soundjay.com/button/beep-07.mp3');
                            audio.play();
                            
                            fetchBookDetails(rawCode);
                        }
                    }
                } else {
                    // If the number changed (glitch), reset the counter
                    lastDetectedCode = rawCode;
                    detectionCount = 0;
                }
            });
        }

        function stopScan() {
            Quagga.stop();
            document.getElementById('scanner-container').style.display = 'none';
        }

        // --- 3. API LOGIC ---
        async function fetchBookDetails(isbn) {
            const cleanISBN = isbn.trim().replace(/-/g, "");
            document.getElementById('status-msg').innerText = `Verifying ISBN: ${cleanISBN}...`;

            try {
                const url = `https://openlibrary.org/api/books?bibkeys=ISBN:${cleanISBN}&jscmd=data&format=json`;
                const response = await fetch(url);
                const data = await response.json();
                const bookData = Object.values(data)[0];

                if (bookData) {
                    const newBook = {
                        title: bookData.title,
                        author: bookData.authors ? bookData.authors.map(a => a.name).join(", ") : "Unknown Author",
                        cover: bookData.cover ? bookData.cover.medium : "https://via.placeholder.com/50x75?text=No+Cover",
                        isbn: cleanISBN
                    };

                    books.unshift(newBook); 
                    saveAndRender();
                    document.getElementById('status-msg').innerText = `Added: ${newBook.title}`;
                } else {
                    alert(`Book not found for ISBN: ${cleanISBN}. \nTry scanning slightly slower.`);
                    document.getElementById('status-msg').innerText = "Ready to scan.";
                }
            } catch (error) {
                console.error(error);
                alert("Network error.");
            }
        }

        // --- 4. UI HELPER FUNCTIONS ---
        function saveAndRender() {
            localStorage.setItem('myLibrary', JSON.stringify(books));
            renderList();
        }

        function renderList() {
            const list = document.getElementById('book-list');
            list.innerHTML = "";
            books.forEach((book, index) => {
                const li = document.createElement('li');
                li.className = 'book-card';
                li.innerHTML = `
                    <img src="${book.cover}" alt="Cover">
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p>${book.author}</p>
                        <p style="font-size:0.7rem; color:#aaa;">${book.isbn}</p>
                    </div>
                    <button class="delete-btn" onclick="removeBook(${index})">X</button>
                `;
                list.appendChild(li);
            });
        }

        function removeBook(index) {
            if(confirm("Remove this book?")) {
                books.splice(index, 1);
                saveAndRender();
            }
        }
    </script>
</body>
</html>